<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>TKA by Hanzzy - Tes Kemampuan Akademik</title>
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:opsz,wght@14..32,400;14..32,500;14..32,600;14..32,700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; }
        body { background: #f0f4f8; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start; padding: 20px; }
        .container { max-width: 1000px; width: 100%; margin: 0 auto; }

        /* LOGIN PAGE */
        .login-container { background: white; border-radius: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); padding: 50px 40px; max-width: 600px; margin: 0 auto; position: relative; }
        .welcome-box { background: linear-gradient(135deg, #2563eb, #7c3aed); border-radius: 30px; padding: 25px; margin-bottom: 30px; text-align: center; color: white; font-weight: 700; font-size: 1.8rem; letter-spacing: 1px; box-shadow: 0 10px 20px rgba(37,99,235,0.3); }
        .login-container h1 { font-size: 2.8rem; font-weight: 700; color: #1e293b; margin-bottom: 10px; text-align: center; }
        .login-container h1 span { background: linear-gradient(135deg, #2563eb, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-container .sub { color: #64748b; font-size: 1.2rem; margin-bottom: 30px; text-align: center; }
        .token-box { background: #f1f5f9; border-radius: 30px; padding: 25px; margin-bottom: 30px; border: 2px dashed #94a3b8; }
        .token-label { font-size: 1.2rem; color: #475569; margin-bottom: 10px; text-align: center; }
        .token-value { font-family: monospace; font-size: 2.5rem; font-weight: 700; letter-spacing: 8px; color: #2563eb; background: white; padding: 15px 20px; border-radius: 60px; border: 2px solid #cbd5e1; display: inline-block; width: 100%; text-align: center; }
        .input-group { text-align: left; margin-bottom: 25px; }
        .input-group label { display: block; font-weight: 600; color: #334155; margin-bottom: 8px; font-size: 1.1rem; }
        .input-group input, .input-group select { width: 100%; padding: 16px 20px; border: 2px solid #cbd5e1; border-radius: 60px; font-size: 1.2rem; outline: none; transition: 0.15s; background: white; }
        .input-group input:focus, .input-group select:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }
        .gender-group { display: flex; gap: 30px; align-items: center; padding: 10px 0; }
        .gender-group label { display: flex; align-items: center; gap: 10px; font-weight: 500; color: #334155; font-size: 1.2rem; cursor: pointer; }
        .gender-group input[type="radio"] { width: 20px; height: 20px; accent-color: #2563eb; }
        .tanggal-lahir { display: flex; gap: 15px; flex-wrap: wrap; }
        .tanggal-lahir select { flex: 1; min-width: 100px; }
        .btn-login { background: #2563eb; color: white; font-size: 1.8rem; font-weight: 600; padding: 16px 30px; border: none; border-radius: 70px; width: 100%; cursor: pointer; box-shadow: 0 8px 0 #1e40af; transition: 0.1s; margin-top: 15px; }
        .btn-login:active { transform: translateY(5px); box-shadow: 0 3px 0 #1e40af; }
        .error-message { color: #ef4444; font-size: 1rem; margin-top: 15px; min-height: 20px; text-align: center; }
        .penalty-message { background: #fee2e2; border: 2px solid #ef4444; color: #b91c1c; padding: 15px; border-radius: 30px; margin-bottom: 20px; font-weight: 600; }

        /* ADMIN BUTTON */
        .admin-icon { position: absolute; top: 20px; right: 20px; cursor: pointer; background: #f1f5f9; padding: 12px 18px; border-radius: 50px; font-weight: 600; color: #1e293b; border: 2px solid #cbd5e1; transition: 0.2s; }
        .admin-icon:hover { background: #2563eb; color: white; border-color: #2563eb; }

        /* KARAKTER PAGE */
        .karakter-page, .soal-page, .konfirmasi-page, .pilih-mapel-page, .admin-page { display: none; }
        .header-card { background: white; border-radius: 24px; padding: 22px 30px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; border-left: 10px solid #2563eb; flex-wrap: wrap; gap: 15px; }
        .header-card h2 { font-size: 2rem; font-weight: 600; color: #0f172a; display: flex; align-items: center; gap: 15px; }
        .header-card h2 i { color: #2563eb; font-size: 2.2rem; }
        .user-info { background: #f1f5f9; padding: 10px 25px; border-radius: 50px; font-size: 1.2rem; color: #1e293b; border: 2px solid #cbd5e1; }
        .timer { background: #f1f5f9; padding: 12px 28px; border-radius: 50px; font-size: 1.6rem; font-weight: 700; color: #0f172a; border: 2px solid #cbd5e1; letter-spacing: 1px; }
        .battery { background: #f1f5f9; padding: 8px 20px; border-radius: 40px; font-size: 1.3rem; font-weight: 600; color: #0f172a; border: 2px solid #cbd5e1; display: flex; align-items: center; gap: 8px; }
        .battery i { font-size: 1.5rem; color: #2563eb; }

        /* SOAL WRAPPER */
        .soal-wrapper { display: flex; flex-direction: column; gap: 20px; max-height: 600px; overflow-y: auto; padding-right: 10px; }
        .soal-card { background: white; border-radius: 24px; padding: 28px; box-shadow: 0 5px 15px rgba(0,0,0,0.03); border: 1px solid #e9eef3; }
        .soal-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .soal-nomor { background: #2563eb; color: white; width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.3rem; box-shadow: 0 6px 12px rgba(37,99,235,0.25); }
        .soal-tipe { background: #dbeafe; color: #1e40af; padding: 6px 20px; border-radius: 40px; font-size: 1rem; font-weight: 600; }
        .soal-teks { font-size: 1.15rem; line-height: 1.7; color: #1e293b; margin: 15px 0 25px; white-space: pre-line; background: #f8fafc; padding: 20px; border-radius: 18px; border-left: 6px solid #2563eb; }
        .opsi { display: flex; flex-direction: column; gap: 12px; }
        .opsi-item { display: flex; align-items: center; gap: 18px; background: #f9fafc; border: 2px solid #e2e8f0; border-radius: 50px; padding: 14px 22px; cursor: pointer; transition: 0.15s; font-size: 1.05rem; }
        .opsi-item:hover { background: #eff6ff; border-color: #2563eb; }
        .opsi-item input { width: 24px; height: 24px; cursor: pointer; accent-color: #2563eb; }
        .opsi-item label { flex: 1; font-size: 1.05rem; cursor: pointer; color: #1e293b; font-weight: 500; }
        .btn-submit { background: #10b981; color: white; font-size: 1.8rem; font-weight: 600; padding: 18px 35px; border: none; border-radius: 70px; width: 100%; max-width: 400px; margin: 35px auto 0; display: block; cursor: pointer; box-shadow: 0 8px 0 #059669; transition: 0.1s; }
        .btn-submit:active { transform: translateY(5px); box-shadow: 0 3px 0 #059669; }
        .error-submit { color: #ef4444; text-align: center; margin: 10px 0; font-size: 1.1rem; }

        /* KONFIRMASI MAPEL */
        .konfirmasi-card { background: white; border-radius: 40px; padding: 50px; text-align: center; max-width: 600px; margin: 40px auto; box-shadow: 0 20px 40px rgba(0,0,0,0.1); border: 2px solid #2563eb; }
        .konfirmasi-card h2 { font-size: 2.8rem; color: #2563eb; margin-bottom: 20px; }
        .konfirmasi-info { font-size: 1.8rem; font-weight: 600; color: #1e293b; margin: 15px 0; }
        .konfirmasi-info span { color: #2563eb; }
        .konfirmasi-pesan { font-size: 1.4rem; color: #334155; margin: 30px 0; font-style: italic; }
        .btn-lanjut { background: #2563eb; color: white; font-size: 2rem; font-weight: 700; padding: 20px 40px; border: none; border-radius: 80px; cursor: pointer; box-shadow: 0 8px 0 #1e40af; transition: 0.1s; width: 100%; max-width: 400px; margin: 20px auto; }
        .btn-lanjut:active { transform: translateY(5px); box-shadow: 0 3px 0 #1e40af; }

        /* PILIH MAPEL */
        .pilih-mapel-page { background: white; border-radius: 32px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); padding: 50px 40px; text-align: center; }
        .pilih-mapel-page h1 { font-size: 3.2rem; font-weight: 700; color: #1e293b; margin-bottom: 15px; }
        .pilih-mapel-page h1 span { background: linear-gradient(135deg, #2563eb, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .pilih-mapel-page .sub { color: #64748b; font-size: 1.3rem; margin-bottom: 30px; border-bottom: 1px solid #e2e8f0; padding-bottom: 25px; }
        .card-grid { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; }
        .home-card { background: #f8fafc; width: 280px; padding: 40px 25px; border-radius: 28px; cursor: pointer; transition: 0.25s; border: 2px solid transparent; }
        .home-card:hover { border-color: #2563eb; transform: translateY(-6px); box-shadow: 0 15px 30px rgba(37,99,235,0.1); }
        .home-card i { font-size: 4rem; color: #2563eb; margin-bottom: 20px; }
        .home-card h2 { font-size: 2.2rem; font-weight: 600; color: #0f172a; }

        /* MODAL KONFIRMASI SELESAI */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-card { background: white; max-width: 450px; width: 90%; border-radius: 40px; padding: 40px 30px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
        .modal-card i { font-size: 4rem; color: #f59e0b; margin-bottom: 20px; }
        .modal-card h3 { font-size: 2rem; font-weight: 600; color: #0f172a; margin-bottom: 15px; }
        .modal-card p { font-size: 1.2rem; color: #475569; margin-bottom: 30px; }
        .modal-actions { display: flex; gap: 15px; justify-content: center; }
        .modal-actions .modal-btn { width: auto; padding: 14px 30px; font-size: 1.3rem; border: none; border-radius: 60px; cursor: pointer; box-shadow: 0 5px 0 #059669; transition: 0.1s; }
        .modal-actions .modal-btn.primary { background: #10b981; color: white; box-shadow: 0 5px 0 #059669; }
        .modal-actions .modal-btn.secondary { background: #94a3b8; color: white; box-shadow: 0 5px 0 #64748b; }
        .modal-actions .modal-btn:active { transform: translateY(3px); box-shadow: 0 2px 0 #059669; }

        /* HASIL PANEL */
        .hasil-panel { background: white; border-radius: 32px; padding: 35px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); margin-top: 30px; }
        .nilai-box { background: #f1f5f9; padding: 20px 35px; border-radius: 70px; font-size: 2rem; font-weight: 700; display: inline-block; color: #0f172a; border: 2px solid #cbd5e1; }
        .key-area { background: #f1f5f9; border-radius: 35px; padding: 30px; margin: 25px 0; border: 2px dashed #94a3b8; }
        .key-string { font-family: monospace; font-size: 2.2rem; background: white; padding: 12px 30px; border-radius: 60px; display: inline-block; letter-spacing: 4px; border: 2px solid #94a3b8; color: #0f172a; margin: 10px 0; word-break: break-all; }
        .exit-form { display: flex; gap: 15px; flex-wrap: wrap; align-items: center; background: #f1f5f9; padding: 25px; border-radius: 60px; }
        .exit-form input { flex: 2; min-width: 250px; background: white; border: 2px solid #cbd5e1; padding: 16px 25px; border-radius: 60px; font-size: 1.3rem; color: #0f172a; text-align: center; font-family: monospace; outline: none; }
        .exit-form button { flex: 1; background: #ef4444; border: none; padding: 16px 25px; border-radius: 60px; font-weight: 600; font-size: 1.4rem; color: white; cursor: pointer; box-shadow: 0 6px 0 #b91c1c; border: 1px solid #fecaca; }
        .exit-form button:active { transform: translateY(4px); box-shadow: 0 2px 0 #b91c1c; }
        .peringatan { color: #475569; font-size: 1rem; margin-top: 20px; text-align: center; }

        /* ADMIN PAGE - DIPERBAIKI RAPIH */
        .admin-page { background: white; border-radius: 40px; padding: 35px; max-width: 900px; margin: 0 auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); border: 2px solid #2563eb; }
        .admin-page h2 { font-size: 2.5rem; color: #2563eb; margin-bottom: 25px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 12px; }
        .admin-page h2 i { font-size: 2.8rem; }
        .admin-password { display: flex; gap: 12px; max-width: 500px; margin: 25px auto; flex-wrap: wrap; justify-content: center; }
        .admin-password input { flex: 2; min-width: 250px; padding: 16px 22px; border: 2px solid #cbd5e1; border-radius: 60px; font-size: 1.1rem; outline: none; transition: 0.15s; }
        .admin-password input:focus { border-color: #2563eb; box-shadow: 0 0 0 3px rgba(37,99,235,0.2); }
        .admin-password button { background: #2563eb; color: white; border: none; padding: 16px 32px; border-radius: 60px; font-weight: 600; font-size: 1.2rem; cursor: pointer; box-shadow: 0 5px 0 #1e40af; transition: 0.1s; }
        .admin-password button:active { transform: translateY(4px); box-shadow: 0 1px 0 #1e40af; }
        .admin-rekap { margin-top: 30px; background: #f8fafc; border-radius: 30px; padding: 20px; border: 2px solid #e2e8f0; }
        .admin-rekap h3 { font-size: 1.8rem; color: #0f172a; margin-bottom: 20px; text-align: center; }
        .table-wrapper { overflow-x: auto; border-radius: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; border-radius: 20px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        th { background: #2563eb; color: white; padding: 15px 12px; font-weight: 600; font-size: 1.1rem; }
        td { padding: 12px; border-bottom: 1px solid #e2e8f0; text-align: center; color: #1e293b; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f1f5f9; }
        .btn-kembali { background: #64748b; color: white; border: none; padding: 14px 35px; border-radius: 60px; margin-top: 25px; cursor: pointer; font-size: 1.3rem; font-weight: 600; box-shadow: 0 5px 0 #475569; transition: 0.1s; display: inline-block; }
        .btn-kembali:active { transform: translateY(4px); box-shadow: 0 1px 0 #475569; }
        .admin-error { color: #ef4444; font-size: 1.1rem; text-align: center; margin-top: 15px; font-weight: 500; }

        /* RINCIAN JAWABAN */
        .rincian-item { margin: 15px 0; padding: 15px; border-radius: 20px; background: #f8fafc; border-left: 6px solid; }
        .rincian-item.benar { border-left-color: #10b981; }
        .rincian-item.salah { border-left-color: #ef4444; }
        .rincian-header { display: flex; justify-content: space-between; font-weight: 600; margin-bottom: 10px; }
        .jawaban-user { color: #1e293b; }
        .kunci-jawaban { color: #2563eb; font-weight: 500; }
        .footer { text-align: center; margin-top: 30px; color: #64748b; }
        .soal-wrapper::-webkit-scrollbar { width: 8px; }
        .soal-wrapper::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media (max-width: 600px) {
            .login-container { padding: 30px 20px; }
            .welcome-box { font-size: 1.4rem; padding: 15px; }
            .token-value { font-size: 1.8rem; letter-spacing: 4px; }
            .gender-group { flex-direction: column; align-items: flex-start; gap: 10px; }
            .tanggal-lahir select { min-width: 80px; }
            .konfirmasi-card { padding: 30px; }
            .konfirmasi-card h2 { font-size: 2rem; }
            .admin-password input { min-width: 100%; }
            .admin-password button { width: 100%; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- HALAMAN LOGIN -->
    <div id="loginPage" class="login-container">
        <div class="admin-icon" id="adminIcon"><i class="fas fa-user-shield"></i> Admin</div>
        <div class="welcome-box">SELAMAT DATANG DI TES KEMAMPUAN AKADEMIK BY HANZZY</div>
        <h1><span>TKA</span> by Hanzzy</h1>
        <div class="sub">Masukkan token dan data diri untuk memulai</div>
        <div id="penaltyMessage" class="penalty-message" style="display: none;"></div>
        <div class="token-box">
            <div class="token-label">Token Akses</div>
            <div class="token-value" id="tokenDisplay">ABCD12</div>
        </div>
        <div class="input-group"><label>Masukkan Token</label><input type="text" id="tokenInput" placeholder="Salin token di atas" autocomplete="off"></div>
        <div class="input-group"><label>Nama Lengkap</label><input type="text" id="namaInput" placeholder="Masukkan nama Anda" autocomplete="off"></div>
        <div class="input-group"><label>Jenis Kelamin</label><div class="gender-group"><label><input type="radio" name="gender" value="Laki-laki" checked> Laki-laki</label><label><input type="radio" name="gender" value="Perempuan"> Perempuan</label></div></div>
        <div class="input-group"><label>Tanggal Lahir</label><div class="tanggal-lahir"><select id="tgl" required><option value="">Tanggal</option></select><select id="bln" required><option value="">Bulan</option></select><select id="thn" required><option value="">Tahun</option></select></div></div>
        <button class="btn-login" id="btnLogin">MASUK</button>
        <div class="error-message" id="loginError"></div>
    </div>

    <!-- HALAMAN ADMIN (RAPIH) -->
    <div id="adminPage" class="admin-page">
        <h2><i class="fas fa-user-shield"></i> Panel Admin</h2>
        <div class="admin-password">
            <input type="password" id="adminPass" placeholder="Masukkan password">
            <button id="adminLoginBtn">Login</button>
        </div>
        <div id="adminRekap" class="admin-rekap" style="display: none;">
            <h3>ðŸ“‹ Rekap Nilai Peserta</h3>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr><th>No</th><th>Nama</th><th>B.Indo</th><th>Matematika</th><th>Total</th><th>Tanggal</th></tr>
                    </thead>
                    <tbody id="rekapBody"></tbody>
                </table>
            </div>
            <div style="text-align: center; margin-top: 25px;">
                <button class="btn-kembali" id="kembaliDariAdmin"><i class="fas fa-arrow-left"></i> Kembali ke Login</button>
            </div>
        </div>
        <div id="adminError" class="admin-error"></div>
    </div>

    <!-- TES KARAKTER (5 SOAL) -->
    <div id="karakterPage" class="karakter-page">
        <div class="header-card">
            <h2><i class="fas fa-user-check"></i> Tes Karakter Siswa</h2>
            <div class="user-info" id="karakterUser">User</div>
            <div class="timer" id="karakterTimer">00:10:00</div>
        </div>
        <div class="soal-wrapper" id="karakterSoalContainer"></div>
        <button class="btn-submit" id="submitKarakter">Lanjut ke Pilihan Mapel</button>
        <div id="karakterError" class="error-submit"></div>
    </div>

    <!-- HALAMAN PILIH MAPEL -->
    <div id="pilihMapelPage" class="pilih-mapel-page">
        <h1>Pilih Mata Pelajaran</h1>
        <div class="sub">Tes Kemampuan Akademik</div>
        <div class="card-grid">
            <div class="home-card" id="btnIndo">
                <i class="fas fa-book-open"></i>
                <h2>B.Indonesia</h2>
                <p style="color:#475569;">25 soal | 90 menit</p>
            </div>
            <div class="home-card" id="btnMat">
                <i class="fas fa-calculator"></i>
                <h2>Matematika</h2>
                <p style="color:#475569;">25 soal | 90 menit</p>
            </div>
        </div>
    </div>

    <!-- HALAMAN KONFIRMASI SEBELUM SOAL -->
    <div id="konfirmasiPage" class="konfirmasi-page">
        <div class="konfirmasi-card">
            <h2 id="konfirmasiMapel">BAHASA INDONESIA</h2>
            <div class="konfirmasi-info">WAKTU : <span>90 MENIT</span></div>
            <div class="konfirmasi-info">SOAL : <span>25 SOAL</span></div>
            <div class="konfirmasi-pesan">Pastikan anda sudah berdoa menurut agama dan keyakinan masing-masing.</div>
            <button class="btn-lanjut" id="btnLanjutSoal">LANJUT KE SOAL</button>
        </div>
    </div>

    <!-- HALAMAN SOAL BAHASA INDONESIA -->
    <div id="indoPage" class="soal-page">
        <div class="header-card">
            <h2><i class="fas fa-book-open"></i> Bahasa Indonesia</h2>
            <div class="user-info" id="indoUser">User</div>
            <div class="timer" id="indoTimer">01:30:00</div>
            <div class="battery" id="batteryDisplay"><i class="fas fa-battery-full"></i> <span>100%</span></div>
        </div>
        <div class="soal-wrapper" id="indoSoalContainer"></div>
        <button class="btn-submit" id="submitIndo">Selesai & Lihat Hasil</button>
        <div id="indoError" class="error-submit"></div>
    </div>

    <!-- HALAMAN SOAL MATEMATIKA -->
    <div id="matPage" class="soal-page">
        <div class="header-card">
            <h2><i class="fas fa-calculator"></i> Matematika</h2>
            <div class="user-info" id="matUser">User</div>
            <div class="timer" id="matTimer">01:30:00</div>
            <div class="battery" id="batteryDisplayMat"><i class="fas fa-battery-full"></i> <span>100%</span></div>
        </div>
        <div class="soal-wrapper" id="matSoalContainer"></div>
        <button class="btn-submit" id="submitMat">Selesai & Lihat Hasil</button>
        <div id="matError" class="error-submit"></div>
    </div>

    <!-- MODAL KONFIRMASI SELESAI UJIAN -->
    <div id="modalSelesai" class="modal-overlay">
        <div class="modal-card">
            <i class="fas fa-question-circle"></i>
            <h3>Yakin ingin mengakhiri ujian?</h3>
            <p>Pastikan semua jawaban sudah final. Anda tidak dapat mengubahnya setelah ini.</p>
            <div class="modal-actions">
                <button class="modal-btn secondary" id="batalSelesai">Tidak</button>
                <button class="modal-btn primary" id="konfirmasiSelesai">Ya</button>
            </div>
        </div>
    </div>

    <!-- HALAMAN HASIL AKHIR -->
    <div id="hasilPage" class="soal-page">
        <div class="hasil-panel" id="hasilPanel"></div>
    </div>
</div>

<script>
(function() {
    // ==================== BANK SOAL BAHASA INDONESIA (25 SOAL) ====================
    // Tanpa menjodohkan, terdiri dari PG, PGK, dan BS
    const bankIndo = [
        // PG (15 soal)
        { tipe: 'pg', teks: 'Bacalah teks berikut!\n\n"Pentingnya coding di era digital semakin terasa. Coding tidak hanya untuk membuat aplikasi, tetapi juga melatih logika dan kreativitas."\n\nManfaat utama coding menurut teks adalah...', opsi: [{teks:'Membuat aplikasi saja',nilai:'A'},{teks:'Melatih logika dan kreativitas',nilai:'B'},{teks:'Menjadi programmer',nilai:'C'},{teks:'Menambah penghasilan',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: '"Literasi digital mencakup kemampuan mencari, menggunakan, dan menyebarkan informasi secara efektif."\n\nKomponen utama literasi digital adalah...', opsi: [{teks:'Membaca buku',nilai:'A'},{teks:'Mengolah informasi',nilai:'B'},{teks:'Mengetik cepat',nilai:'C'},{teks:'Bermain game',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: '"Perpustakaan digital menjadi alternatif sumber belajar bagi siswa."\n\nTopik utama teks tersebut adalah...', opsi: [{teks:'Buku cetak',nilai:'A'},{teks:'Perpustakaan digital',nilai:'B'},{teks:'Cara belajar',nilai:'C'},{teks:'Teknologi',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Keunggulan perpustakaan digital menurut teks adalah...', opsi: [{teks:'Gratis',nilai:'A'},{teks:'Mudah diakses',nilai:'B'},{teks:'Buku tebal',nilai:'C'},{teks:'Tanpa listrik',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Bacalah kutipan cerpen!\n\n"Matahari mulai condong ke barat, stasiun tua itu sunyi."\n\nLatar suasana adalah...', opsi: [{teks:'Gembira',nilai:'A'},{teks:'Sunyi',nilai:'B'},{teks:'Ramai',nilai:'C'},{teks:'Mencekam',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Bacalah puisi!\n\n"Hujan di bulan Juni tak ada yang lebih tabah."\n\nMajas yang digunakan adalah...', opsi: [{teks:'Personifikasi',nilai:'A'},{teks:'Metafora',nilai:'B'},{teks:'Hiperbola',nilai:'C'},{teks:'Litotes',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: '"Polusi udara menjadi masalah di kota besar."\n\nMasalah utama yang dibahas adalah...', opsi: [{teks:'Sampah',nilai:'A'},{teks:'Polusi udara',nilai:'B'},{teks:'Kemacetan',nilai:'C'},{teks:'Banjir',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Penyebab polusi udara menurut teks adalah...', opsi: [{teks:'Asap kendaraan',nilai:'A'},{teks:'Limbah rumah',nilai:'B'},{teks:'Penebangan',nilai:'C'},{teks:'Pertanian',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: '"Festival budaya melestarikan tradisi daerah."\n\nTujuan festival adalah...', opsi: [{teks:'Menarik investor',nilai:'A'},{teks:'Melestarikan tradisi',nilai:'B'},{teks:'Menghibur turis',nilai:'C'},{teks:'Industri',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: '"Menjaga pola hidup sehat dengan olahraga dan makanan bergizi."\n\nCara menjaga kesehatan adalah...', opsi: [{teks:'Tidur larut',nilai:'A'},{teks:'Olahraga',nilai:'B'},{teks:'Obat',nilai:'C'},{teks:'Malas',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Manfaat pola hidup sehat adalah...', opsi: [{teks:'Menambah berat',nilai:'A'},{teks:'Daya tahan tubuh',nilai:'B'},{teks:'Mengurangi aktivitas',nilai:'C'},{teks:'Menghemat waktu',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Larik tepat untuk melengkapi pantun:\nNegeri sakura nun jauh di sana\n...\nJanganlah suka menghina\nBelum tentu dirimu lebih baik', opsi: [{teks:'Alangkah senang memakan daging itik',nilai:'A'},{teks:'Daging itik enak',nilai:'B'},{teks:'Itik mirip bebek',nilai:'C'},{teks:'Daging itik lezat',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Ciri-ciri pantun, kecuali...', opsi: [{teks:'Bait ganjil',nilai:'A'},{teks:'Bait genap',nilai:'B'},{teks:'Sampiran-isi',nilai:'C'},{teks:'Bersajak',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Kata "pendeta" mengalami gejala...', opsi: [{teks:'Spesialisasi',nilai:'A'},{teks:'Asosiasi',nilai:'B'},{teks:'Peyorasi',nilai:'C'},{teks:'Ameliorasi',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Contoh penulisan alamat surat dinas yang benar adalah...', opsi: [{teks:'Yth. Bapak Kepala SMA',nilai:'A'},{teks:'Yth. Bapak Kepala Sekolah SMA',nilai:'B'},{teks:'YTH. Kepada...',nilai:'C'},{teks:'KEPALA SEKOLAH',nilai:'D'}], kunci: 'A' },
        // PGK (5 soal)
        { tipe: 'pgk', teks: 'Unsur-unsur dalam teks berita adalah... (pilih semua)', opsi: [{teks:'5W+1H',nilai:'A'},{teks:'Judul',nilai:'B'},{teks:'Opini penulis',nilai:'C'},{teks:'Fakta',nilai:'D'}], kunci: ['A','B','D'] },
        { tipe: 'pgk', teks: 'Ciri-ciri teks eksposisi adalah... (pilih semua)', opsi: [{teks:'Informatif',nilai:'A'},{teks:'Fakta',nilai:'B'},{teks:'Meyakinkan',nilai:'C'},{teks:'Kiasan',nilai:'D'}], kunci: ['A','B','C'] },
        { tipe: 'pgk', teks: 'Kata kerja mental adalah... (pilih semua)', opsi: [{teks:'Memikirkan',nilai:'A'},{teks:'Membaca',nilai:'B'},{teks:'Menyimpulkan',nilai:'C'},{teks:'Menendang',nilai:'D'}], kunci: ['A','C'] },
        { tipe: 'pgk', teks: 'Konjungsi temporal terdapat dalam... (pilih semua)', opsi: [{teks:'Ia lalu pergi',nilai:'A'},{teks:'Dia sambil menulis',nilai:'B'},{teks:'Karena hujan',nilai:'C'},{teks:'Saya makan sambil menonton',nilai:'D'}], kunci: ['A','B','D'] },
        { tipe: 'pgk', teks: 'Jenis paragraf berdasarkan letak kalimat utama adalah... (pilih semua)', opsi: [{teks:'Deduktif',nilai:'A'},{teks:'Induktif',nilai:'B'},{teks:'Campuran',nilai:'C'},{teks:'Deskriptif',nilai:'D'}], kunci: ['A','B','C'] },
        // Benar/Salah (5 soal)
        { tipe: 'bs', teks: 'Frasa "rumah sakit" berpola D-M.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' },
        { tipe: 'bs', teks: 'Kata "ambiguitas" berarti ketidakjelasan.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' },
        { tipe: 'bs', teks: 'Teks anekdot bersifat menghibur dan mengandung kritik.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' },
        { tipe: 'bs', teks: 'Pantun bersajak a-b-a-b.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' },
        { tipe: 'bs', teks: 'Kata "konotasi" adalah makna sebenarnya.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'B' }
    ];

    // ==================== BANK SOAL MATEMATIKA (25 SOAL) ====================
    const bankMat = [
        // PG (15 soal)
        { tipe: 'pg', teks: 'Hasil dari (-12) : 3 + (-8) x (-5) adalah...\nA. -44\nB. -36\nC. 36\nD. 44', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'D' },
        { tipe: 'pg', teks: 'Bentuk sederhana 2âˆš27 + 3âˆš3 / âˆš12 adalah...\nA. 3âˆš3\nB. 4âˆš3\nC. 5âˆš3\nD. 6âˆš3', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'C' },
        { tipe: 'pg', teks: 'Hasil dari 10â»Â² adalah...\nA. -100\nB. -20\nC. 0,2\nD. 0,01', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'D' },
        { tipe: 'pg', teks: 'Skor Olimpiade: benar 5, salah -2, tidak -1. Dari 40 soal, Andi benar 30, salah 6. Skor Andi...\nA. 132\nB. 138\nC. 142\nD. 148', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Mobil 1,6 jam, 75 km/jam. Jika 1 jam, kecepatan = ... km/jam\nA. 100\nB. 110\nC. 120\nD. 130', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'C' },
        { tipe: 'pg', teks: '3(4x+3)=6x-15. Nilai 3n+7 = ...\nA. -5\nB. -2\nC. 2\nD. 5', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Bayu beli baju Rp55.000, ongkir Rp15.000. Uang Rp385.000, maks baju...\nA. 5\nB. 6\nC. 7\nD. 8', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: 'Penyelesaian x+y=7 dan x-y=3 adalah...\nA. (2,5)\nB. (5,2)\nC. (-3,10)\nD. (10,-3)', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'B' },
        { tipe: 'pg', teks: '3x+10 > 6x-8 â†’ ...\nA. x<2\nB. x>2\nC. x<6\nD. x>6', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'C' },
        { tipe: 'pg', teks: 'f(x)=2x-3, f(-1)=...\nA. 5\nB. 1\nC. -1\nD. -5', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'D' },
        { tipe: 'pg', teks: 'f(x)=8-2x, f(a)=-2 â†’ a=...\nA. -5\nB. -3\nC. 3\nD. 5', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'D' },
        { tipe: 'pg', teks: 'Barisan 4,6,p,10,12,14,q. p+q=...\nA. 24\nB. 26\nC. 28\nD. 30', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Dadu dilambung, peluang faktor 6 = ...\nA. 1/6\nB. 1/2\nC. 2/3\nD. 5/6', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'C' },
        { tipe: 'pg', teks: 'Keluarga 2 anak, peluang kedua perempuan = ...\nA. 1/4\nB. 1/2\nC. 3/4\nD. 1', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Kebun belah ketupat, diagonal 24 m & 18 m. Keliling = ... m\nA. 60\nB. 84\nC. 100\nD. 120', opsi: [{teks:'A',nilai:'A'},{teks:'B',nilai:'B'},{teks:'C',nilai:'C'},{teks:'D',nilai:'D'}], kunci: 'A' },
        // PGK (5 soal)
        { tipe: 'pgk', teks: 'Bilangan prima antara 10 dan 20 adalah... (pilih semua)', opsi: [{teks:'11',nilai:'A'},{teks:'13',nilai:'B'},{teks:'17',nilai:'C'},{teks:'19',nilai:'D'},{teks:'15',nilai:'E'}], kunci: ['A','B','C','D'] },
        { tipe: 'pgk', teks: 'Sifat-sifat persegi panjang adalah... (pilih semua)', opsi: [{teks:'Sisi berhadapan sejajar',nilai:'A'},{teks:'Keempat sisi sama',nilai:'B'},{teks:'Sudut siku-siku',nilai:'C'},{teks:'Diagonal tegak lurus',nilai:'D'}], kunci: ['A','C'] },
        { tipe: 'pgk', teks: 'Faktor dari 12 adalah... (pilih semua)', opsi: [{teks:'1',nilai:'A'},{teks:'2',nilai:'B'},{teks:'3',nilai:'C'},{teks:'4',nilai:'D'},{teks:'6',nilai:'E'},{teks:'12',nilai:'F'}], kunci: ['A','B','C','D','E','F'] },
        { tipe: 'pgk', teks: 'Bilangan genap adalah... (pilih semua)', opsi: [{teks:'2',nilai:'A'},{teks:'4',nilai:'B'},{teks:'6',nilai:'C'},{teks:'9',nilai:'D'}], kunci: ['A','B','C'] },
        { tipe: 'pgk', teks: 'Satuan berat adalah... (pilih semua)', opsi: [{teks:'kg',nilai:'A'},{teks:'gram',nilai:'B'},{teks:'ons',nilai:'C'},{teks:'liter',nilai:'D'}], kunci: ['A','B','C'] },
        // Benar/Salah (5 soal)
        { tipe: 'bs', teks: 'Hasil dari (-5) + 8 = 3.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' },
        { tipe: 'bs', teks: 'Akar dari 144 adalah 14.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'B' },
        { tipe: 'bs', teks: 'Rumus keliling lingkaran adalah 2Ï€r.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' },
        { tipe: 'bs', teks: 'Fungsi f(x)=2x+1 adalah fungsi linear.', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' },
        { tipe: 'bs', teks: '1 hektar = 10.000 mÂ².', opsi: [{teks:'Benar',nilai:'A'},{teks:'Salah',nilai:'B'}], kunci: 'A' }
    ];

    // ==================== TES KARAKTER (5 soal) ====================
    const soalKarakter = [
        { tipe: 'pg', teks: 'Apakah Anda memiliki motivasi tinggi untuk belajar?', opsi: [{teks:'Ya, selalu',nilai:'A'},{teks:'Kadang-kadang',nilai:'B'},{teks:'Tidak terlalu',nilai:'C'},{teks:'Tidak sama sekali',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Bagaimana sikap Anda terhadap tantangan akademik?', opsi: [{teks:'Sangat antusias',nilai:'A'},{teks:'Biasa saja',nilai:'B'},{teks:'Menghindar',nilai:'C'},{teks:'Takut',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Seberapa sering belajar di luar jam sekolah?', opsi: [{teks:'Setiap hari',nilai:'A'},{teks:'3-4 kali',nilai:'B'},{teks:'1-2 kali',nilai:'C'},{teks:'Tidak pernah',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Apakah suka membaca buku non-pelajaran?', opsi: [{teks:'Sangat suka',nilai:'A'},{teks:'Cukup suka',nilai:'B'},{teks:'Kadang',nilai:'C'},{teks:'Tidak suka',nilai:'D'}], kunci: 'A' },
        { tipe: 'pg', teks: 'Bagaimana mengatur waktu belajar?', opsi: [{teks:'Terjadwal',nilai:'A'},{teks:'Kadang terjadwal',nilai:'B'},{teks:'Belajar jika ada tugas',nilai:'C'},{teks:'Tidak pernah',nilai:'D'}], kunci: 'A' }
    ];

    // ==================== STATE ====================
    let currentToken = generateToken();
    let isLocked = false;
    let currentMapel = null; // 'indo' atau 'mat'
    let jawabanKarakter = new Array(5).fill(null);
    let jawabanIndo = null;
    let jawabanMat = null;
    let soalIndoTerpilih = [];
    let soalMatTerpilih = [];
    let currentExitKey = '';
    let userData = { nama: '', gender: '', tgl: '', bln: '', thn: '' };
    let timerInterval = null;
    let waktuTersisa = 90 * 60; // 90 menit
    let awayTimer = null;
    let isPenaltyActive = false;
    let karakterSelesai = false;
    let indoSelesai = false;
    let matSelesai = false;
    let hasilKey = '';

    // Data rekap (disimpan di localStorage)
    let rekapData = [];
    function loadRekap() {
        const stored = localStorage.getItem('tkaRekapHanzzy');
        if (stored) try { rekapData = JSON.parse(stored); } catch { rekapData = []; }
        else rekapData = [];
    }
    function saveRekap() {
        localStorage.setItem('tkaRekapHanzzy', JSON.stringify(rekapData));
    }
    loadRekap();

    // Elemen DOM
    const loginPage = document.getElementById('loginPage');
    const adminPage = document.getElementById('adminPage');
    const karakterPage = document.getElementById('karakterPage');
    const pilihMapelPage = document.getElementById('pilihMapelPage');
    const konfirmasiPage = document.getElementById('konfirmasiPage');
    const konfirmasiMapel = document.getElementById('konfirmasiMapel');
    const indoPage = document.getElementById('indoPage');
    const matPage = document.getElementById('matPage');
    const hasilPage = document.getElementById('hasilPage');
    const modalSelesai = document.getElementById('modalSelesai');
    const tokenDisplay = document.getElementById('tokenDisplay');
    const tokenInput = document.getElementById('tokenInput');
    const namaInput = document.getElementById('namaInput');
    const btnLogin = document.getElementById('btnLogin');
    const loginError = document.getElementById('loginError');
    const penaltyMessage = document.getElementById('penaltyMessage');
    const karakterUser = document.getElementById('karakterUser');
    const indoUser = document.getElementById('indoUser');
    const matUser = document.getElementById('matUser');
    const karakterTimer = document.getElementById('karakterTimer');
    const indoTimer = document.getElementById('indoTimer');
    const matTimer = document.getElementById('matTimer');
    const batteryDisplay = document.getElementById('batteryDisplay');
    const batteryDisplayMat = document.getElementById('batteryDisplayMat');
    const karakterSoalContainer = document.getElementById('karakterSoalContainer');
    const indoSoalContainer = document.getElementById('indoSoalContainer');
    const matSoalContainer = document.getElementById('matSoalContainer');
    const submitKarakter = document.getElementById('submitKarakter');
    const submitIndo = document.getElementById('submitIndo');
    const submitMat = document.getElementById('submitMat');
    const btnIndo = document.getElementById('btnIndo');
    const btnMat = document.getElementById('btnMat');
    const btnLanjutSoal = document.getElementById('btnLanjutSoal');
    const btnBatalSelesai = document.getElementById('batalSelesai');
    const btnKonfirmasiSelesai = document.getElementById('konfirmasiSelesai');
    const karakterError = document.getElementById('karakterError');
    const indoError = document.getElementById('indoError');
    const matError = document.getElementById('matError');
    const hasilPanel = document.getElementById('hasilPanel');
    const adminIcon = document.getElementById('adminIcon');
    const adminLoginBtn = document.getElementById('adminLoginBtn');
    const adminPass = document.getElementById('adminPass');
    const adminRekap = document.getElementById('adminRekap');
    const rekapBody = document.getElementById('rekapBody');
    const adminError = document.getElementById('adminError');
    const kembaliDariAdmin = document.getElementById('kembaliDariAdmin');

    // Fungsi generate token
    function generateToken() {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
        let token = '';
        for (let i = 0; i < 6; i++) token += chars[Math.floor(Math.random() * chars.length)];
        return token;
    }
    tokenDisplay.textContent = currentToken;

    // Dropdown tanggal lahir
    const tglSelect = document.getElementById('tgl');
    const blnSelect = document.getElementById('bln');
    const thnSelect = document.getElementById('thn');
    for (let i = 1; i <= 31; i++) { let opt = document.createElement('option'); opt.value = i; opt.textContent = i; tglSelect.appendChild(opt); }
    for (let i = 1; i <= 12; i++) { let opt = document.createElement('option'); opt.value = i; opt.textContent = i; blnSelect.appendChild(opt); }
    for (let i = 1980; i <= 2010; i++) { let opt = document.createElement('option'); opt.value = i; opt.textContent = i; thnSelect.appendChild(opt); }

    // ==================== FUNGSI BATERAI ====================
    function updateBattery() {
        if ('getBattery' in navigator) {
            navigator.getBattery().then(function(battery) {
                const level = Math.round(battery.level * 100);
                let icon = 'fa-battery-empty';
                if (level >= 90) icon = 'fa-battery-full';
                else if (level >= 60) icon = 'fa-battery-three-quarters';
                else if (level >= 40) icon = 'fa-battery-half';
                else if (level >= 15) icon = 'fa-battery-quarter';
                else icon = 'fa-battery-empty';
                if (batteryDisplay) {
                    batteryDisplay.innerHTML = `<i class="fas ${icon}"></i> <span>${level}%</span>`;
                }
                if (batteryDisplayMat) {
                    batteryDisplayMat.innerHTML = `<i class="fas ${icon}"></i> <span>${level}%</span>`;
                }
                battery.addEventListener('levelchange', updateBattery);
                battery.addEventListener('chargingchange', updateBattery);
            });
        } else {
            if (batteryDisplay) batteryDisplay.innerHTML = `<i class="fas fa-battery-full"></i> <span>100%</span>`;
            if (batteryDisplayMat) batteryDisplayMat.innerHTML = `<i class="fas fa-battery-full"></i> <span>100%</span>`;
        }
    }

    // ==================== FUNGSI PENALTY 5 MENIT ====================
    function checkPenalty() {
        const penaltyEnd = localStorage.getItem('penaltyEnd');
        if (penaltyEnd) {
            const now = Date.now();
            const remaining = parseInt(penaltyEnd) - now;
            if (remaining > 0) {
                isPenaltyActive = true;
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                penaltyMessage.style.display = 'block';
                penaltyMessage.innerHTML = `âš ï¸ Anda terkena sanksi 5 menit karena keluar paksa. Silakan tunggu ${minutes} menit ${seconds} detik.`;
                const countdown = setInterval(() => {
                    const remainingNow = parseInt(localStorage.getItem('penaltyEnd')) - Date.now();
                    if (remainingNow <= 0) {
                        clearInterval(countdown);
                        penaltyMessage.style.display = 'none';
                        isPenaltyActive = false;
                        localStorage.removeItem('penaltyEnd');
                    } else {
                        const mins = Math.floor(remainingNow / 60000);
                        const secs = Math.floor((remainingNow % 60000) / 1000);
                        penaltyMessage.innerHTML = `âš ï¸ Anda terkena sanksi 5 menit karena keluar paksa. Silakan tunggu ${mins} menit ${secs} detik.`;
                    }
                }, 1000);
                return true;
            } else {
                localStorage.removeItem('penaltyEnd');
                isPenaltyActive = false;
            }
        }
        return false;
    }

    function startViolationDetection() {
        document.addEventListener('visibilitychange', onVisibilityChange);
        window.addEventListener('blur', onBlur);
        window.addEventListener('focus', onFocus);
    }
    function stopViolationDetection() {
        document.removeEventListener('visibilitychange', onVisibilityChange);
        window.removeEventListener('blur', onBlur);
        window.removeEventListener('focus', onFocus);
        if (awayTimer) clearTimeout(awayTimer);
    }
    function onVisibilityChange() {
        if (document.hidden && isLocked) {
            awayTimer = setTimeout(() => applyPenalty(), 2000);
        } else if (awayTimer) clearTimeout(awayTimer);
    }
    function onBlur() {
        if (isLocked) awayTimer = setTimeout(() => applyPenalty(), 2000);
    }
    function onFocus() { if (awayTimer) clearTimeout(awayTimer); }
    function applyPenalty() {
        if (!isLocked || isPenaltyActive) return;
        hentikanTimer();
        // Reset semua jawaban
        jawabanKarakter.fill(null);
        jawabanIndo = null;
        jawabanMat = null;
        const penaltyEnd = Date.now() + 5 * 60 * 1000; // 5 menit
        localStorage.setItem('penaltyEnd', penaltyEnd);
        exitFullscreen();
        setLock(false);
        // Kembali ke login
        loginPage.style.display = 'block';
        adminPage.style.display = 'none';
        karakterPage.style.display = 'none';
        pilihMapelPage.style.display = 'none';
        konfirmasiPage.style.display = 'none';
        indoPage.style.display = 'none';
        matPage.style.display = 'none';
        hasilPage.style.display = 'none';
        checkPenalty();
        alert('âš ï¸ Keluar paksa! Jawaban di-reset + sanksi 5 menit.');
    }

    // ==================== LOGIN ====================
    btnLogin.addEventListener('click', () => {
        if (checkPenalty()) { loginError.textContent = 'Anda masih dalam masa sanksi.'; return; }
        const inputToken = tokenInput.value.trim().toUpperCase();
        const nama = namaInput.value.trim();
        const gender = document.querySelector('input[name="gender"]:checked')?.value;
        const tgl = tglSelect.value;
        const bln = blnSelect.value;
        const thn = thnSelect.value;
        if (inputToken === '') { loginError.textContent = 'Token harus diisi.'; return; }
        if (nama === '') { loginError.textContent = 'Nama harus diisi.'; return; }
        if (!gender) { loginError.textContent = 'Pilih jenis kelamin.'; return; }
        if (!tgl || !bln || !thn) { loginError.textContent = 'Tanggal lahir harus lengkap.'; return; }
        if (inputToken !== currentToken) { loginError.textContent = 'Token salah.'; return; }
        userData = { nama, gender, tgl, bln, thn };
        loginError.textContent = '';
        // Tampilkan halaman tes karakter
        loginPage.style.display = 'none';
        karakterPage.style.display = 'block';
        karakterUser.textContent = `${nama} (${gender}) - ${tgl}/${bln}/${thn}`;
        renderSoal(karakterSoalContainer, 'karakter', soalKarakter, jawabanKarakter);
        // Timer karakter 10 menit
        waktuTersisa = 10 * 60;
        mulaiTimerKarakter();
        setLock(true);
        startViolationDetection();
        openFullscreen();
        updateBattery();
    });

    // Timer khusus karakter
    function mulaiTimerKarakter() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (waktuTersisa <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                // Otomatis lanjut ke pilih mapel
                karakterSelesai = true;
                karakterPage.style.display = 'none';
                pilihMapelPage.style.display = 'block';
            } else {
                waktuTersisa--;
                karakterTimer.textContent = formatWaktu(waktuTersisa);
            }
        }, 1000);
    }

    // Timer untuk mapel (90 menit)
    function mulaiTimerMapel(mapel) {
        if (timerInterval) clearInterval(timerInterval);
        waktuTersisa = 90 * 60;
        const timerElement = mapel === 'indo' ? indoTimer : matTimer;
        timerElement.textContent = formatWaktu(waktuTersisa);
        timerInterval = setInterval(() => {
            if (waktuTersisa <= 0) {
                clearInterval(timerInterval);
                timerInterval = null;
                // Submit otomatis
                if (mapel === 'indo') {
                    if (jawabanIndo && jawabanIndo.includes(null)) {
                        alert('Waktu habis! Beberapa soal belum dijawab.');
                    }
                    submitIndo.click();
                } else {
                    if (jawabanMat && jawabanMat.includes(null)) {
                        alert('Waktu habis! Beberapa soal belum dijawab.');
                    }
                    submitMat.click();
                }
            } else {
                waktuTersisa--;
                timerElement.textContent = formatWaktu(waktuTersisa);
            }
        }, 1000);
    }

    function hentikanTimer() {
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = null;
    }

    function formatWaktu(detik) {
        let jam = Math.floor(detik / 3600);
        let menit = Math.floor((detik % 3600) / 60);
        let det = detik % 60;
        return `${jam.toString().padStart(2,'0')}:${menit.toString().padStart(2,'0')}:${det.toString().padStart(2,'0')}`;
    }

    // Render soal
    function renderSoal(container, mapel, soalArray, jawabanArray) {
        let html = '';
        soalArray.forEach((soal, idx) => {
            const nomor = idx + 1;
            let tipeLabel = soal.tipe === 'pg' ? 'Pilihan Ganda' : (soal.tipe === 'pgk' ? 'PG Kompleks' : 'Benar/Salah');
            html += `<div class="soal-card" data-nomor="${idx}" data-tipe="${soal.tipe}"><div class="soal-header"><div class="soal-nomor">${nomor}</div><div class="soal-tipe">${tipeLabel}</div></div>`;
            html += `<div class="soal-teks">${soal.teks}</div><div class="opsi">`;
            
            if (soal.tipe === 'pg' || soal.tipe === 'pgk' || soal.tipe === 'bs') {
                soal.opsi.forEach((opt, optIdx) => {
                    const inputType = (soal.tipe === 'pgk') ? 'checkbox' : 'radio';
                    const name = `opt_${mapel}_${idx}`;
                    let checked = false;
                    if (jawabanArray && jawabanArray[idx] !== null) {
                        if (soal.tipe === 'pgk') {
                            checked = jawabanArray[idx].includes(opt.nilai);
                        } else {
                            checked = (jawabanArray[idx] === opt.nilai);
                        }
                    }
                    html += `<div class="opsi-item"><input type="${inputType}" name="${name}" value="${opt.nilai}" id="${name}_${optIdx}" ${checked ? 'checked' : ''}><label for="${name}_${optIdx}">${opt.teks}</label></div>`;
                });
            }
            html += `</div></div>`;
        });
        container.innerHTML = html;

        // Event listener untuk radio/checkbox
        container.querySelectorAll('.soal-card').forEach((item) => {
            const nomor = parseInt(item.dataset.nomor);
            const tipe = item.dataset.tipe;
            const opsiDiv = item.querySelector('.opsi');
            opsiDiv.addEventListener('change', (e) => {
                if (tipe === 'pgk') {
                    const checkedValues = [];
                    opsiDiv.querySelectorAll('input[type=checkbox]:checked').forEach(cb => checkedValues.push(cb.value));
                    jawabanArray[nomor] = checkedValues;
                } else {
                    const selected = opsiDiv.querySelector('input[type=radio]:checked');
                    if (selected) {
                        jawabanArray[nomor] = selected.value;
                    }
                }
            });
        });
    }

    // Fungsi untuk mengambil 25 soal acak dari bank
    function pilihSoalAcak(bank, jumlah) {
        const shuffled = [...bank].sort(() => Math.random() - 0.5);
        return shuffled.slice(0, jumlah);
    }

    // ==================== TES KARAKTER ====================
    submitKarakter.addEventListener('click', () => {
        if (!semuaTerisi(karakterSoalContainer, jawabanKarakter)) {
            karakterError.textContent = 'Semua soal harus dijawab!';
            return;
        }
        karakterError.textContent = '';
        karakterSelesai = true;
        hentikanTimer();
        karakterPage.style.display = 'none';
        pilihMapelPage.style.display = 'block';
    });

    function semuaTerisi(container, jawabanArray) {
        // Untuk karakter hanya PG, cukup cek null
        return jawabanArray.every(v => v !== null);
    }

    // ==================== PILIH MAPEL & KONFIRMASI ====================
    btnIndo.addEventListener('click', () => {
        konfirmasiMapel.textContent = 'BAHASA INDONESIA';
        currentMapel = 'indo';
        pilihMapelPage.style.display = 'none';
        konfirmasiPage.style.display = 'block';
    });

    btnMat.addEventListener('click', () => {
        konfirmasiMapel.textContent = 'MATEMATIKA';
        currentMapel = 'mat';
        pilihMapelPage.style.display = 'none';
        konfirmasiPage.style.display = 'block';
    });

    btnLanjutSoal.addEventListener('click', () => {
        konfirmasiPage.style.display = 'none';
        if (currentMapel === 'indo') {
            soalIndoTerpilih = pilihSoalAcak(bankIndo, 25);
            jawabanIndo = new Array(25).fill(null);
            indoPage.style.display = 'block';
            indoUser.textContent = `${userData.nama} (${userData.gender}) - ${userData.tgl}/${userData.bln}/${userData.thn}`;
            renderSoal(indoSoalContainer, 'indo', soalIndoTerpilih, jawabanIndo);
            mulaiTimerMapel('indo');
        } else {
            soalMatTerpilih = pilihSoalAcak(bankMat, 25);
            jawabanMat = new Array(25).fill(null);
            matPage.style.display = 'block';
            matUser.textContent = `${userData.nama} (${userData.gender}) - ${userData.tgl}/${userData.bln}/${userData.thn}`;
            renderSoal(matSoalContainer, 'mat', soalMatTerpilih, jawabanMat);
            mulaiTimerMapel('mat');
        }
    });

    // ==================== SUBMIT MAPEL ====================
    submitIndo.addEventListener('click', () => {
        if (!jawabanIndo || !semuaTerisi(indoSoalContainer, jawabanIndo)) {
            indoError.textContent = 'Semua soal harus dijawab!';
            return;
        }
        indoSelesai = true;
        hentikanTimer();
        if (matSelesai) {
            // Tampilkan modal konfirmasi selesai
            modalSelesai.classList.add('active');
        } else {
            indoPage.style.display = 'none';
            pilihMapelPage.style.display = 'block';
        }
    });

    submitMat.addEventListener('click', () => {
        if (!jawabanMat || !semuaTerisi(matSoalContainer, jawabanMat)) {
            matError.textContent = 'Semua soal harus dijawab!';
            return;
        }
        matSelesai = true;
        hentikanTimer();
        if (indoSelesai) {
            modalSelesai.classList.add('active');
        } else {
            matPage.style.display = 'none';
            pilihMapelPage.style.display = 'block';
        }
    });

    btnBatalSelesai.addEventListener('click', () => {
        modalSelesai.classList.remove('active');
        // Kembali ke pilih mapel
        if (currentMapel === 'indo') {
            indoPage.style.display = 'none';
        } else {
            matPage.style.display = 'none';
        }
        pilihMapelPage.style.display = 'block';
    });

    btnKonfirmasiSelesai.addEventListener('click', () => {
        modalSelesai.classList.remove('active');
        tampilkanHasilAkhir();
    });

    function semuaTerisi(container, jawabanArray) {
        for (let i = 0; i < jawabanArray.length; i++) {
            if (jawabanArray[i] === null) return false;
            if (Array.isArray(jawabanArray[i]) && jawabanArray[i].length === 0) return false;
        }
        return true;
    }

    function hitungSkor(soalArray, jawabanArray) {
        let benar = 0;
        for (let i = 0; i < soalArray.length; i++) {
            const soal = soalArray[i];
            const jawab = jawabanArray[i];
            if (soal.tipe === 'pg' || soal.tipe === 'bs') {
                if (jawab === soal.kunci) benar++;
            } else if (soal.tipe === 'pgk') {
                const kunciSet = new Set(soal.kunci);
                const jawabSet = new Set(jawab);
                if (kunciSet.size === jawabSet.size && [...kunciSet].every(k => jawabSet.has(k))) benar++;
            }
        }
        return benar;
    }

    function tampilkanHasilAkhir() {
        const skorIndo = hitungSkor(soalIndoTerpilih, jawabanIndo);
        const skorMat = hitungSkor(soalMatTerpilih, jawabanMat);
        const totalSoal = 50;
        const totalBenar = skorIndo + skorMat;
        const persen = (totalBenar / totalSoal * 100).toFixed(2);
        hasilKey = 'EXIT-' + Math.random().toString(36).substring(2,10).toUpperCase();
        currentExitKey = hasilKey;

        // Simpan ke rekap
        const tanggal = new Date().toLocaleString('id-ID');
        rekapData.push({
            nama: userData.nama,
            indo: skorIndo,
            mat: skorMat,
            total: totalBenar,
            tanggal: tanggal
        });
        saveRekap();

        // Buat rincian jawaban
        let rincianIndo = '<h3 style="margin:20px 0 10px;">Rincian Jawaban Bahasa Indonesia:</h3>';
        soalIndoTerpilih.forEach((soal, idx) => {
            const jawab = jawabanIndo[idx];
            const kunci = soal.kunci;
            let status = 'salah';
            let jawabTeks = Array.isArray(jawab) ? jawab.join(', ') : jawab;
            if (soal.tipe === 'pg' || soal.tipe === 'bs') {
                if (jawab === kunci) status = 'benar';
            } else if (soal.tipe === 'pgk') {
                const kunciSet = new Set(soal.kunci);
                const jawabSet = new Set(jawab);
                if (kunciSet.size === jawabSet.size && [...kunciSet].every(k => jawabSet.has(k))) status = 'benar';
            }
            rincianIndo += `<div class="rincian-item ${status}">
                <div class="rincian-header"><span>Soal ${idx+1}</span> <span>${status === 'benar' ? 'âœ…' : 'âŒ'}</span></div>
                <div class="jawaban-user">Jawaban Anda: ${jawabTeks}</div>
                <div class="kunci-jawaban">Kunci: ${kunci}</div>
            </div>`;
        });

        let rincianMat = '<h3 style="margin:20px 0 10px;">Rincian Jawaban Matematika:</h3>';
        soalMatTerpilih.forEach((soal, idx) => {
            const jawab = jawabanMat[idx];
            const kunci = soal.kunci;
            let status = 'salah';
            let jawabTeks = Array.isArray(jawab) ? jawab.join(', ') : jawab;
            if (soal.tipe === 'pg' || soal.tipe === 'bs') {
                if (jawab === kunci) status = 'benar';
            } else if (soal.tipe === 'pgk') {
                const kunciSet = new Set(soal.kunci);
                const jawabSet = new Set(jawab);
                if (kunciSet.size === jawabSet.size && [...kunciSet].every(k => jawabSet.has(k))) status = 'benar';
            }
            rincianMat += `<div class="rincian-item ${status}">
                <div class="rincian-header"><span>Soal ${idx+1}</span> <span>${status === 'benar' ? 'âœ…' : 'âŒ'}</span></div>
                <div class="jawaban-user">Jawaban Anda: ${jawabTeks}</div>
                <div class="kunci-jawaban">Kunci: ${kunci}</div>
            </div>`;
        });

        let html = `
            <div class="nilai-box">Skor Akhir: ${totalBenar}/${totalSoal} (${persen}%)</div>
            <div style="margin:20px 0; font-size:1.5rem;">B.Indo: ${skorIndo}/25 | Matematika: ${skorMat}/25</div>
            ${rincianIndo}
            ${rincianMat}
            <div class="key-area">
                <div style="font-size:1.3rem;">ðŸ”‘ KELUAR KEY</div>
                <div class="key-string">${hasilKey}</div>
                <button class="copyKeyBtn" style="background:#2563eb; color:white; border:none; padding:12px 30px; border-radius:40px; margin-top:10px; cursor:pointer;">ðŸ“‹ Salin Key</button>
            </div>
            <div class="exit-form">
                <input type="text" id="exitKeyInput" placeholder="masukkan key keluar">
                <button id="exitBtn">ðŸšª KELUAR</button>
            </div>
            <div class="peringatan">âš ï¸ Key salah tidak bisa keluar</div>
        `;
        hasilPanel.innerHTML = html;
        hasilPage.style.display = 'block';
        indoPage.style.display = 'none';
        matPage.style.display = 'none';
        pilihMapelPage.style.display = 'none';
        konfirmasiPage.style.display = 'none';

        document.querySelector('.copyKeyBtn')?.addEventListener('click', () => {
            navigator.clipboard.writeText(hasilKey).then(() => alert('Key disalin!'));
        });
        document.getElementById('exitBtn')?.addEventListener('click', () => {
            const input = document.getElementById('exitKeyInput').value.trim();
            if (input === currentExitKey) {
                alert('âœ… Key benar. Keluar dari tes.');
                exitFullscreen();
                setLock(false);
                stopViolationDetection();
                location.reload(); // Kembali ke login
            } else {
                alert('âŒ Key salah!');
            }
        });
    }

    // ==================== ADMIN PANEL (DIPERBAIKI RAPIH) ====================
    adminIcon.addEventListener('click', () => {
        loginPage.style.display = 'none';
        adminPage.style.display = 'block';
        adminRekap.style.display = 'none';
        adminError.innerHTML = '';
        adminPass.value = '';
    });

    kembaliDariAdmin.addEventListener('click', () => {
        adminPage.style.display = 'none';
        loginPage.style.display = 'block';
    });

    adminLoginBtn.addEventListener('click', () => {
        const pass = adminPass.value;
        // Password: HANZZY 250511 (base64 untuk sedikit tersembunyi)
        const correctPass = btoa('HANZZY 250511');
        if (btoa(pass) === correctPass) {
            adminError.innerHTML = '';
            tampilkanRekap();
            adminRekap.style.display = 'block';
        } else {
            adminError.innerHTML = 'Password salah!';
            adminRekap.style.display = 'none';
        }
    });

    function tampilkanRekap() {
        let rows = '';
        if (rekapData.length === 0) {
            rows = '<tr><td colspan="6" style="text-align:center;">Belum ada data peserta</td></tr>';
        } else {
            rekapData.forEach((item, i) => {
                rows += `<tr>
                    <td>${i+1}</td>
                    <td>${item.nama}</td>
                    <td>${item.indo}/25</td>
                    <td>${item.mat}/25</td>
                    <td>${item.total}/50</td>
                    <td>${item.tanggal}</td>
                </tr>`;
            });
        }
        rekapBody.innerHTML = rows;
    }

    // ==================== FUNGSI FULLSCREEN & LOCK ====================
    function setLock(lock) {
        isLocked = lock;
        if (lock) {
            window.onbeforeunload = (e) => { e.preventDefault(); e.returnValue = 'Tes berlangsung! Gunakan KEY.'; return 'Tes berlangsung! Gunakan KEY.'; };
            history.pushState(null, null, location.href);
            window.addEventListener('popstate', preventBack);
        } else {
            window.onbeforeunload = null;
            window.removeEventListener('popstate', preventBack);
        }
    }
    function preventBack() { if (isLocked) { history.pushState(null, null, location.href); alert('ðŸš« Tombol back diblokir!'); } }
    document.addEventListener('keydown', (e) => {
        if (!isLocked) return;
        const key = e.key, ctrl = e.ctrlKey, shift = e.shiftKey, alt = e.altKey;
        const blocked = [ key === 'F12', ctrl && shift && (key === 'I' || key === 'J' || key === 'C'), ctrl && key === 'U', key === 'F5', ctrl && (key === 'r' || key === 'R'), ctrl && shift && (key === 'r' || key === 'R'), ctrl && (key === 'w' || key === 'W'), ctrl && (key === 'f4' || key === 'F4'), alt && (key === 'F4'), ctrl && (key === 't' || key === 'T' || key === 'n' || key === 'N'), ctrl && (key === 'p' || key === 'P'), ctrl && (key === 's' || key === 'S'), alt && (key === 'ArrowLeft' || key === 'ArrowRight'), key === 'PrintScreen' ];
        if (blocked.includes(true)) { e.preventDefault(); alert('ðŸ”’ Akses ditolak!'); return false; }
        if (ctrl || alt) { e.preventDefault(); alert('ðŸ”’ Tombol kombinasi diblokir.'); return false; }
    });
    document.addEventListener('contextmenu', (e) => { if (isLocked) e.preventDefault(); });
    document.addEventListener('copy', (e) => { if (isLocked) e.preventDefault(); });
    document.addEventListener('cut', (e) => { if (isLocked) e.preventDefault(); });
    document.addEventListener('paste', (e) => { if (isLocked) e.preventDefault(); });
    setInterval(() => {
        if (isLocked && (window.outerWidth - window.innerWidth > 200 || window.outerHeight - window.innerHeight > 200)) {
            alert('ðŸ”’ DevTools terdeteksi!'); applyPenalty();
        }
    }, 1000);
    function openFullscreen() { let elem = document.documentElement; if (elem.requestFullscreen) elem.requestFullscreen(); else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen(); else if (elem.msRequestFullscreen) elem.msRequestFullscreen(); }
    function exitFullscreen() { if (document.exitFullscreen) document.exitFullscreen(); else if (document.webkitExitFullscreen) document.webkitExitFullscreen(); else if (document.msExitFullscreen) document.msExitFullscreen(); }

    // Render awal
    checkPenalty();
})();
</script>
</body>
</html>
